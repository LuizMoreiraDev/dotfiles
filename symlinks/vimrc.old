" frazrepo/vim-rainbow
" let g:rainbow_active = 1

if has('nvim')
  exe 'luafile '.stdpath('config').'/nvim.lua'
  " nnoremap <leader>p <cmd>lua require('telescope.builtin').find_files()<cr>
  " nnoremap <leader>b <cmd>lua require('telescope.builtin').buffers()<cr>
  " nnoremap <Leader>jl :Telescope find_files search_dirs=["./lib"]<CR>
  " nnoremap <Leader>js :Telescope find_files search_dirs=["./spec"]<CR>
  " nnoremap <Leader>jm :Telescope find_files search_dirs=["./app/models"]<CR>

  " akinsho/toggleterm.nvim
  autocmd TermEnter term://*toggleterm#* tnoremap <silent><c-t> <Cmd>exe v:count1 . "ToggleTerm"<CR>
  nnoremap <silent><c-\> <Cmd>exe v:count1 . "ToggleTerm"<CR>
  tnoremap <silent><c-\> <Cmd>exe v:count1 . "ToggleTerm"<CR>
else
  nnoremap <silent><c-\> <Cmd>:terminal<CR>
endif

" ===== FZF =====
function! RipgrepFzf(query, fullscreen)
  let command_fmt = 'rg --column --line-number --no-heading --color=always --smart-case -- %s || true'
  let initial_command = printf(command_fmt, shellescape(a:query))
  let reload_command = printf(command_fmt, '{q}')
  let spec = {'options': ['--disabled', '--query', a:query, '--bind', 'change:reload:'.reload_command]}
  let spec = fzf#vim#with_preview(spec, 'right', 'ctrl-/')
  call fzf#vim#grep(initial_command, 1, spec, a:fullscreen)
endfunction
command! -nargs=* -bang RG call RipgrepFzf(<q-args>, <bang>0)

" Closes fzf on <ESC>
autocmd! FileType fzf tnoremap <buffer> <esc> <c-c>

let g:fzf_buffers_jump = 1
let g:fzf_preview_window = []
let g:fzf_layout = { 'window': { 'width': 0.8, 'height': 0.4 } }
let g:fzf_action = { 'ctrl-t': 'tab split', 'ctrl-s': 'split', 'ctrl-v': 'vsplit' }

nnoremap <Leader>p :Files<CR>
nnoremap <Leader>b :Buffers<cr>
nnoremap <Leader>t :History<CR>
nnoremap <Leader>r :RG<CR>
nnoremap <Leader>ja :Files app<CR>
nnoremap <Leader>jl :Files lib<CR>
nnoremap <Leader>jn :Files models<CR>
nnoremap <Leader>jv :Files app/views<CR>
nnoremap <Leader>jm :Files app/models<CR>
nnoremap <Leader>jc :Files app/controllers<CR>
nnoremap <Leader>js :Files spec<CR>
" ===== FZF =====

" " CtrlP
" nnoremap <Leader>p :CtrlP<CR>
" nnoremap <Leader>b :CtrlPBuffer<cr>
" nnoremap <Leader>t :CtrlPMRUFiles<CR>
" nnoremap <Leader>jl :CtrlP lib<CR>
" nnoremap <Leader>jn :CtrlP models<CR>
" nnoremap <Leader>jv :CtrlP app/views<CR>
" nnoremap <Leader>jm :CtrlP app/models<CR>
" nnoremap <Leader>jc :CtrjP app/controllers<CR>
" nnoremap <Leader>js :CtrlP spec<CR>

" if exists("g:ctrlp_user_command")
"   unlet g:ctrlp_user_command
" endif
" if executable('ag')
"   " Use ag in CtrlP for listing files. Lightning fast and respects .gitignore
"   let g:ctrlp_user_command = 'ag %s --files-with-matches -g "" --ignore "\.git$\|\.hg$\|\.svn$"'
"
"   " ag is fast enough that CtrlP doesn't need to cache
"   " let g:ctrlp_use_caching = 0
" else
"   " Fall back to using git ls-files if Ag is not available
"   let g:ctrlp_custom_ignore = '\.git$\|\.hg$\|\.svn$'
"   let g:ctrlp_user_command  = ['.git', 'cd %s && git ls-files . --cached --exclude-standard --others']
" endif

" NERDTree
let NERDTreeWinSize=50
nnoremap <Leader>k :NERDTreeToggle<CR>
" Stolen from https://github.com/skwp/dotfiles
function! FindInNerdTree()
  if &modifiable && strlen(expand('%')) > 0 && !&diff
    NERDTreeFind
  endif
endfunction
nnoremap <Leader>n :call FindInNerdTree()<CR>

" COC - BEGIN
" let g:coc_global_extensions = ['coc-snippets', 'coc-solargraph']
if has('nvim')
  let g:coc_global_extensions = [
        \ 'coc-diagnostic',
        \ 'coc-json',
        \ 'coc-yaml',
        \ 'coc-tsserver',
        \ 'coc-eslint',
        \ 'coc-solargraph',
        \ 'coc-css',
        \ 'coc-snippets',
        \ ]
  set nowritebackup
  set updatetime=300
  set signcolumn=yes
  inoremap <silent><expr> <TAB>
        \ coc#pum#visible() ? coc#pum#next(1) :
        \ CheckBackspace() ? "\<Tab>" :
        \ coc#refresh()
  inoremap <expr><S-TAB> coc#pum#visible() ? coc#pum#prev(1) : "\<C-h>"
  inoremap <silent><expr> <CR> coc#pum#visible() ? coc#pum#confirm()
                                \: "\<C-g>u\<CR>\<c-r>=coc#on_enter()\<CR>"
  function! CheckBackspace() abort
    let col = col('.') - 1
    return !col || getline('.')[col - 1]  =~# '\s'
  endfunction

  " Use <c-space> to trigger completion
  inoremap <silent><expr> <c-space> coc#refresh()

  " Use `[g` and `]g` to navigate diagnostics
  " Use `:CocDiagnostics` to get all diagnostics of current buffer in location list
  nmap <silent> [g <Plug>(coc-diagnostic-prev)
  nmap <silent> ]g <Plug>(coc-diagnostic-next)
  nmap <silent> gu <Plug>(coc-diagnostic-next)

  " GoTo code navigation
  nmap <silent> gd <Plug>(coc-definition)
  nmap <silent> gy <Plug>(coc-type-definition)
  nmap <silent> gi <Plug>(coc-implementation)
  nmap <silent> gr <Plug>(coc-references)
endif
""" COC - END

" switch between the last two files
nnoremap <leader><leader> <c-^>

" copy / paste
vnoremap y  "+y
nnoremap yy "+yy
" nnoremap <leader>cp <esc>:let @+=@%<cr>
nnoremap <leader>cp <esc>:let @+ = expand("%")<cr>

" split
nnoremap vv :vsplit<cr>
nnoremap ss :split<cr>

" hide highlight search
nmap <silent>qq :silent :nohlsearch<CR>

" B = kill current buffer
" W = save current file
" Q = kill current pane/window
nnoremap <silent>B <esc>:bd<cr>
nnoremap <silent>W <esc>:w<cr>
nnoremap <silent>Q <esc><C-w>q

" move between split panes/windows using H, J, K, L
nnoremap <silent><C-h> <C-w>h
nnoremap <silent><C-l> <C-w>l
nnoremap <silent><C-k> <C-w>k
nnoremap <silent><C-j> <C-w>j

" paste toggle
nnoremap <F8> :set invpaste paste?<CR>
set pastetoggle=<F8>

" EasyAlign
nmap ga <Plug>(EasyAlign)
xmap ga <Plug>(EasyAlign)

" ctags
let g:Tlist_Ctags_Cmd="rm tags && ctags --exclude='*.js'"
map <Leader>ct :!ctags -R .<CR>

" auto format before saving
au BufWrite * :retab!
au BufWrite * :RemoveTrailingSpaces

" air-line
let g:airline_powerline_fonts = 1


if !exists('g:airline_symbols')
    let g:airline_symbols = {}
endif

" airline symbols
let g:airline_left_sep = ''
let g:airline_left_alt_sep = ''
let g:airline_right_sep = ''
let g:airline_right_alt_sep = ''
let g:airline_symbols.branch = ''
let g:airline_symbols.readonly = ''
let g:airline_symbols.linenr = ''
let g:airline_theme = 'gruvbox'
" let g:airline_theme = 'solarized'
" let g:airline_theme = 'solarized_flood'
let g:airline#extensions#battery#enabled = 1

set background=dark

" gruvbox
let g:gruvbox_invert_signs=1
let g:gruvbox_contrast_dark="hard"
colorscheme gruvbox
hi clear SignColumn
hi LineNr guibg=NONE ctermbg=NONE
hi VertSplit guibg=NONE ctermbg=NONE
hi Normal guibg=NONE ctermbg=NONE
set fillchars=vert:\│
" / gruvbox

"" nightfox
if (has('nvim') || has('vim'))
  " colorscheme nightfox
  " hi Normal guibg=NONE ctermbg=NONE
else
  set nonumber
  set signcolumn=no
  set colorcolumn=0
  " set lines=43
  " set columns=174
  set guioptions-=T " no toolbar or menus
  set guioptions-=r " no scrollbar on the right
  set guioptions-=R " no scrollbar on the right
  set guioptions-=l " no scrollbar on the left
  set guioptions-=b " no scrollbar on the bottom
  set guioptions-=L " no scrollbar on the nerdtree

  colorscheme default

  if has("gui_mac") || has("gui_macvim")
    set colorcolumn=120
    " set norelativenumber
    " set number
    colorscheme dracula
    set guifont=FantasqueSansMono\ NF:h17
    set transparency=3
  end
endif
"" / nightfox

set secure

" ryanoasis/vim-devicons
if exists("g:loaded_webdevicons")
  call webdevicons#refresh()
endif
